<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cargo-dephell</title>
    <!-- icon with fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"></script>
    <!-- tooltip with tippy -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/shift-away.css">
    <!-- custom -->
    <style>
        @import url('https://fonts.googleapis.com/css?family=Roboto:200,400,700&display=swap');

        * {
            font-family: Roboto;
            box-sizing: border-box;
        }

        body {
            margin:0;
        }

        header {
            background-color:#be4141;
        }

        header h1 {
            color: antiquewhite;
            margin:0;
            padding:20px 0 20px;
        }

        nav {
            margin-bottom:10px;
        }

        nav a {
            text-decoration:none;
            color:black;
        }

        .container {
            max-width: 1000px;
            margin: auto;
        }

        #jumbotron {
            padding:10px;
            background-color:cornsilk;
        }

        #jumbotron a {
            color:black;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        td {
            line-height: 30px;
            font-size: 18px;
        }

        thead {
            color: #FFFFFF;
            background-color: #6c7ae0;
            vertical-align: middle;
        }

        th {
            padding: 10px;
            font-size:15px;
            font-weight:200;
        }

        th a {
            color: white;
            text-decoration: none;
        }

        tr:nth-child(even) {
            background-color: #f8f6ff;
        }

        td {
            font-weight: 200;
            font-size: 15px;
            text-align:center;
            padding:0 5px;
        }
        td:first-child {
            text-align:center;
        }

        td a {
            color:black;
            text-decoration:none;
            border-bottom:1px solid black;
        }


        .hide {
            display: none;
        }

        button {
            text-decoration: none;
            color: white;
            padding: 10px 30px;
            display: inline-block;
            position: relative;
            border: 1px solid rgba(0,0,0,0.21);
            border-bottom: 4px solid rgba(0,0,0,0.21);
            border-radius: 4px;
            text-shadow: 0 1px 0 rgba(0,0,0,0.15);

            padding: 4px 12px;  
            font-size: 12px;

            background: rgba(130,200,160,1);
            background: -moz-linear-gradient(top, rgba(130,200,160,1) 0%, rgba(130,199,158,1) 100%);
            background: -webkit-gradient(left top, left bottom, color-stop(0%, rgba(130,200,160,1)), color-stop(100%, rgba(130,199,158,1)));
            background: -webkit-linear-gradient(top, rgba(130,200,160,1) 0%, rgba(130,199,158,1) 100%);
            background: -o-linear-gradient(top, rgba(130,200,160,1) 0%, rgba(130,199,158,1) 100%);
            background: -ms-linear-gradient(top, rgba(130,200,160,1) 0%, rgba(130,199,158,1) 100%);
            background: linear-gradient(to bottom, rgba(130,200,160,1) 0%, rgba(124, 185, 149, 1) 100%);
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#82c8a0', endColorstr='#82c79e', GradientType=0 );
        }

        button:active  {background: #72B08E;}

    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-fire"></i> Cargo-dephell</h1>
        </div>
    </header>
    <div class="container">
        <p id="jumbotron">
            This page was generated with <a href="https://github.com/mimoo/cargo-dephell">cargo dephell</a>. It lists the dependencies used by <strong>{{ name }}</strong>.<br>
            For more information about the methodology check the <a href="https://github.com/mimoo/cargo-dephell">README</a>.
        </p>
        <nav>
            <div id="buttons">
                <button id="target_feature">show unused dependencies</button>
            </div>
            <hr>
            <div id="crumble"></div>
        </nav>
        <table>
            <thead>
                <tr>
                    <th>
                        <a href="#name" data-tippy-content="the name of the dependency">
                            crate name
                        </a>
                    </th>
                    <th>
                        <a href="#transitive_dependencies" data-tippy-content="the number of dependencies that this package end up adding (if all features are set) not including this package">
                            transitive dependencies
                        </a>
                    </th>
                    <th>
                        <a href="#versions" data-tippy-content="the number of different versions of this dependency that are imported in the workspace">
                            versions imported
                        </a>
                    </th>
                    <th>
                        <a href="#root_importers" data-tippy-content="the number of workspace crates that have this dependency as transitive dependency">
                            imported by
                        </a>
                    </th>
                    <th>
                        <a href="#exclusive_deps_introduced" data-tippy-content="the number of dependencies that are introduced only by having this dependency">
                            exclusive dependencies introduced
                        </a>
                    </th>
                    <th>
                        <a href="#non_rust_loc" data-tippy-content="total lines of code for C, C++, etc. that might end up being imported by having this dependency (this includes transitive dependencies)">
                            lines of non-rust code
                        </a>
                    </th>
                    <th>
                        <a href="#rust_loc" data-tippy-content="total lines of rust code for this dependency and its transitive dependencies">
                            lines of rust code
                        </a>
                    </th>
                    <th>
                        <a href="#unsafe_loc" data-tippy-content="total lines of unsafe rust code for this dependency and its transitive dependencies">
                            unsafe lines
                        </a>
                    </th>
                    <th>
                        <a href="#stargazers_count" data-tippy-content="number of github stars (only if the dependency has a github repository)">
                            github stars
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                
            </tbody>
        </table>
        
    </div>

    <!-- tooltip with tippy -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <!-- custom -->
    <script>
        // TODO: https://github.com/magjac/d3-graphviz for dot
        // TODO: compute total_LOC here

        //
        // metric functions
        //

        // TODO: use this somewhere
        weights = {
            'transitive_dependencies': 5,
            'root_importers': 1,
            'exclusive_deps_introduced': 5,
            'non_rust_loc': 1,
            'rust_loc': 5,
            'unsafe_loc': 1,
            'stargazers_count': 1
        };
        function calculate_risk(package_id) {
            let package_risk = analysis_result[package_id];
            let risk_score = 0;
            for (metric of ['transitive_dependencies', 'root_importers', 'exclusive_deps_introduced', 'non_rust_loc', 'rust_loc', 'unsafe_loc', 'stargazers_count']) {
                let actual_number = package_risk[metric];
                if (Array.isArray(actual_number)) {
                    actual_number = actual_number.length;
                }
                risk_score += weights[metric] * actual_number;
            }
            return risk_score;
        }

        // add total_non_rust_loc, total_rust_loc, total_unsafe_loc fields to each dependency
        function calculate_total_loc(package_id) {
            console.log("calculate_total_loc of", package_id);
            let total_non_rust_loc = 0;
            let total_rust_loc = 0;
            let total_unsafe_loc = 0;
            // does it have any dependencies?
            let transitive_dependencies = analysis_result[package_id]["transitive_dependencies"];
            // no
            if (transitive_dependencies.length == 0) {
                analysis_result[package_id]["total_non_rust_loc"] = analysis_result[package_id]["non_rust_loc"];
                analysis_result[package_id]["total_rust_loc"] = analysis_result[package_id]["rust_loc"];
                analysis_result[package_id]["total_unsafe_loc"] = analysis_result[package_id]["unsafe_loc"];
                return;
            } 
            // yes
            for (transitive_dependency of transitive_dependencies) {
                // already has the information we need or do we recurse?
                if (!analysis_result[transitive_dependency].hasOwnProperty("total_rust_loc")) {
                    calculate_total_loc(transitive_dependency);
                }
                // add up
                total_non_rust_loc += analysis_result[transitive_dependency]["total_non_rust_loc"];
                total_rust_loc += analysis_result[transitive_dependency]["total_rust_loc"];
                total_unsafe_loc += analysis_result[transitive_dependency]["total_unsafe_loc"];
            }
            // update
            console.log("result for", package_id);
            console.log(total_non_rust_loc, total_rust_loc, total_unsafe_loc);
            analysis_result[package_id]["total_non_rust_loc"] = total_non_rust_loc;
            analysis_result[package_id]["total_rust_loc"] = total_rust_loc;
            analysis_result[package_id]["total_unsafe_loc"] = total_unsafe_loc;
        }

        //
        // function to modify the table
        //

        function clean_table() {
            document.querySelector("tbody").innerHTML = "";
        }

        function display_packages(package_ids) {
            // clean
            clean_table();
            // update state
            current_packages = package_ids;
            // display
            for(package_id of package_ids) {
                display_package(package_id);
            }
        }

        function display_package(package_id) {
            let package = analysis_result[package_id];
            let html = "";
            if (package.used) {
                html += '<tr>';
            } else {
                html += '<tr class="not_used hide">';
            }
            html += '<td><a href="'+package_id+'" class="dep_name">' + package["name"] + '</a></td>';
            html += "<td>" + package["transitive_dependencies"].length + "</td>";
            html += "<td>" + package["versions"].length + "</td>";
            html += "<td>" + package["root_importers"].length + "</td>";
            html += "<td>" + package["exclusive_deps_introduced"].length + "</td>";
            html += "<td>" + package["total_non_rust_loc"].toLocaleString() + "</td>";
            html += "<td>" + package["total_rust_loc"].toLocaleString() + "</td>";
            html += "<td>" + package["total_unsafe_loc"].toLocaleString() + "</td>";
            if (package["repo"] != null) {
                html += '<td><a href="'+package["repo"]+'">' + package["stargazers_count"].toLocaleString() + "</a></td>";
            } else {
                html += "<td>" + package["stargazers_count"].toLocaleString() + "</td>";
            }
            html += "</tr>"
            document.querySelector("tbody").innerHTML += html;
        }

        //
        // buttons
        // -------
        //

        // show/hide dependencies that are not part of our (target, features)
        document.querySelector("#target_feature").addEventListener("click", (event) => {
            if (event.target.innerHTML == "show unused dependencies") {
                event.target.innerHTML = "hide unused dependencies";
            } else {
                event.target.innerHTML = "show unused dependencies";
            }
            document.querySelectorAll(".not_used").forEach(
                (elem) => elem.classList.toggle("hide")
            );
        });

        //
        // crumble functions
        // -------------
        //

        let crumble_home = '<a href="#home" class="dep_crumble"><i class="fas fa-home"></i> {{name}}</a>'; 
        let crumble_rest = [];

        function refresh_crumble() {    
            let crumble = crumble_home;
            for (const [idx, dep_id] of crumble_rest.entries()) {
                let dep_name = analysis_result[dep_id]["name"];
                crumble += ' <i class="fas fa-caret-right"></i> <a href="#'+idx+'" class="dep_crumble">' + dep_name + '</a>';
            }
            document.querySelector("#crumble").innerHTML = crumble;
        }

        function crumble_click(dep_id) {
            crumble_rest.push(dep_id);
            refresh_crumble();
        }

        document.querySelector("#crumble").addEventListener("click", (event) => {
            if (event.target && event.target.className != "dep_crumble") {
                return;
            }
            // which element in the array
            let idx = event.target.getAttribute("href").slice(1);
            if (idx == "home") {
                crumble_rest = [];
                display_packages(main_dependencies);
            } else {
                let package_id = crumble_rest[idx];
                crumble_rest = crumble_rest.slice(0, idx + 1);
                display_packages(analysis_result[package_id]["transitive_dependencies"]);
            }
            // refresh crumble
            refresh_crumble();
            //
            event.preventDefault();
        });

        //
        // init
        // ----

        // obtain result and parse JSON
        let {main_dependencies, analysis_result} = JSON.parse('{{ json_result }}');

        // calculate total LOCs:
        for (dependency of main_dependencies) {
            calculate_total_loc(dependency);
        }

        // display main dependencies
        let current_packages = main_dependencies;
        display_packages(main_dependencies);

        // display crumble
        refresh_crumble();

        //
        // clicking on dependencies
        // ------------------------

        // clicking on a dependency gives us a view of a specific dependency
        document.querySelector("tbody").addEventListener("click", (event) => {
            if (event.target && event.target.className != "dep_name") {
                return;
            }
            // get info
            let package_name = event.target.innerHTML;
            let package_id = event.target.getAttribute("href");
            // refresh
            reset_sort_icons();
            crumble_click(package_id);
            display_packages(analysis_result[package_id]["transitive_dependencies"]);
            //
            event.preventDefault();
        });

        //
        // sorting
        // ------

        const sort_buttons = document.querySelectorAll("th a");
        for (const sort_button of sort_buttons) {
            sort_button.addEventListener("click", (event) => sort_click(event));
        }

        function reset_sort_icons() {
            const sort_buttons = document.querySelectorAll("th svg").forEach(e => e.parentNode.removeChild(e));
        }
        
        function sort_click(event) {
            // get info
            let to_sort = event.target.getAttribute("href").slice(1); // get rid of "#..."
            // figure out how to sort
            let sort_asc = false;
            let thing = event.target.querySelector("svg");
            if (thing && thing.classList.contains("fa-sort-down")) {
                sort_asc = true;
            }
            // reset sort icons
            reset_sort_icons();
            // sort and update sort icon
            if (sort_asc) {
                event.target.innerHTML += '<i class="fas fa-sort-up"></i>';
                current_packages.sort((a, b) => {
                    a = analysis_result[a][to_sort];
                    b = analysis_result[b][to_sort];
                    if (Array.isArray(a)) {
                        a = a.length;
                        b = b.length;
                    }
                    return (a > b) ? 1 : -1;
                });
            } else {
                event.target.innerHTML += '<i class="fas fa-sort-down"></i>';
                current_packages.sort((a, b) => {
                    a = analysis_result[a][to_sort];
                    b = analysis_result[b][to_sort];
                    if (Array.isArray(a)) {
                        a = a.length;
                        b = b.length;
                    }
                    return (a < b) ? 1 : -1;
                });
            }
            // refresh table
            display_packages(current_packages);
            //
            event.preventDefault();
        }

        //
        // tooltip for help
        // ----------------

        tippy('[data-tippy-content]', {
            placement: 'bottom',
            animation: 'shift-away'
        });

    </script>
</body>

</html>