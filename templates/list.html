<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cargo-dephell</title>
    <!-- icon with fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"></script>
    <!-- tooltip with tippy -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/shift-away.css">
    <!-- custom -->
    <style>
        @import url('https://fonts.googleapis.com/css?family=Roboto:200,400,700&display=swap');

        * {
            font-family: Roboto;
            box-sizing: border-box;
        }

        body {
            margin:0;
            margin-bottom:50px;
        }

        header {
            background-color:#be4141;
        }

        header h1 {
            color: antiquewhite;
            margin:0;
            padding:20px 0 20px;
        }

        #crumble {
            font-size:15px;
        }

        #crumble a {
            text-decoration:none;
            color:black;
            display:inline-block;
            padding:5px 10px;
        }

        #crumble a:last-child {
            background-color:#77889921;
        }

        #info {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #77889921;
            font-size:13px;
        }

        #info div {
            padding: 5px;
        }

        #description {
            
        }

        #root_crates {
            background-color:rgba(0,0,0,.07);
        }

        .container {
            max-width: 1200px;
            margin: auto;
        }

        #jumbotron {
            padding:10px;
            background-color:cornsilk;
            margin-bottom:10px;
        }

        #jumbotron a {
            color:black;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
        }

        td {
            line-height: 30px;
            font-size: 18px;
        }

        thead {
            color: #FFFFFF;
            background-color: #6c7ae0;
            vertical-align: middle;
        }

        th {
            padding: 10px;
            font-size:15px;
            font-weight:200;
        }

        th a {
            color: white;
            text-decoration: none;
        }

        tr:nth-child(even) {
            background-color: #f8f6ff;
        }

        td {
            font-weight: 200;
            font-size: 15px;
            text-align: right;
            padding:0 10px;
            border: 1px solid rgba(0,0,0,.04);
        }
        td:first-child {
            text-align:     center;
        }

        td a {
            color:black;
            text-decoration:none;
            border-bottom:1px solid black;
        }


        .hide {
            display: none;
        }

        /* button stuff taken from https://codepen.io/FelipeMarcos/pen/tfhEg */

        #buttons {
            margin-bottom:10px;
        }

        button {
            cursor: pointer;
        }

        .btn, .btn-two {
            margin: 9px;
        }
        .btn-gradient {
            margin: 5px;
        }
        a[class*="btn"] {text-decoration: none;}
        input[class*="btn"], 
        button[class*="btn"] {border: 0;}

        /* Here you can change the button sizes */
        .btn.large, 
        .btn-two.large, 
        .btn-effect.large {
        padding: 20px 40px; 
        font-size: 22px;
        }
        .btn.small, 
        .btn-two.small, 
        .btn-gradient.small, 
        .btn-effect.small {
        padding: 8px 18px;  
        font-size: 14px;
        }
        .btn.mini, 
        .btn-two.mini, 
        .btn-gradient.mini, 
        .btn-effect.mini {
        padding: 4px 12px;  
        font-size: 12px;
        }
        .btn.block, 
        .btn-two.block, 
        .btn-gradient.block, 
        .btn-effect.block {
        display: block;
        width: 60%;
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        }
        .btn-gradient.large {
        padding: 15px 45px; 
        font-size: 22px;
        }

        /* Colors for .btn and .btn-two */
        .btn.blue, .btn-two.blue     {background-color: #7fb1bf;}
        .btn.green, .btn-two.green   {background-color: #9abf7f;}
        .btn.red, .btn-two.red       {background-color: #fa5a5a;}
        .btn.purple, .btn-two.purple {background-color: #cb99c5;}
        .btn.cyan, .btn-two.cyan     {background-color: #7fccde;}
        .btn.yellow, .btn-two.yellow {background-color: #f0d264;}

        .rounded {
        border-radius: 10px;
        }

        /* default button style */
        .btn {
            position: relative;
            border: 0;
            padding: 15px 25px;
            display: inline-block;
            text-align: center;
            color: white;
        }
        .btn:active {
            top: 4px;	
        }

        /* color classes for .btn */
        .btn.blue {box-shadow: 0px 4px #74a3b0;}
        .btn.blue:active {box-shadow: 0 0 #74a3b0; background-color: #709CA8;}

        .btn.green {box-shadow: 0px 4px 0px #87a86f;}
        .btn.green:active {box-shadow: 0 0 #87a86f; background-color: #87a86f;}

        .btn.red {box-shadow:0px 4px 0px #E04342;}
        .btn.red:active {box-shadow: 0 0 #ff4c4b; background-color: #ff4c4b;}

        .btn.purple {box-shadow:0px 4px 0px #AD83A8;}
        .btn.purple:active {box-shadow: 0 0 #BA8CB5; background-color: #BA8CB5;}

        .btn.cyan {box-shadow:0px 4px 0px #73B9C9;}
        .btn.cyan:active {box-shadow: 0 0 #73B9C9; background-color: #70B4C4;}

        .btn.yellow {box-shadow:0px 4px 0px #D1B757;}
        .btn.yellow:active {box-shadow: 0 0 #ff4c4b; background-color: #D6BB59;}

        /* Button two - I have no creativity for names */
        .btn-two {
            color: white;	
            padding: 15px 25px;
            display: inline-block;
            border: 1px solid rgba(0,0,0,0.21);
            border-bottom-color: rgba(0,0,0,0.34);
            text-shadow:0 1px 0 rgba(0,0,0,0.15);
            box-shadow: 0 1px 0 rgba(255,255,255,0.34) inset, 
                            0 2px 0 -1px rgba(0,0,0,0.13), 
                            0 3px 0 -1px rgba(0,0,0,0.08), 
                            0 3px 13px -1px rgba(0,0,0,0.21);
        }
        .btn-two:active {
            top: 1px;
            border-color: rgba(0,0,0,0.34) rgba(0,0,0,0.21) rgba(0,0,0,0.21);
            box-shadow: 0 1px 0 rgba(255,255,255,0.89),0 1px rgba(0,0,0,0.05) inset;
            position: relative;
        }
        /* 3D Button */
        .btn-3d {
            position: relative;
            display: inline-block;
            font-size: 22px;
            padding: 20px 60px;
            color: white;
            margin: 20px 10px 10px;
            border-radius: 6px;
            text-align: center;
            transition: top .01s linear;
            text-shadow: 0 1px 0 rgba(0,0,0,0.15);
        }
        .btn-3d.red:hover    {background-color: #e74c3c;}
        .btn-3d.blue:hover   {background-color: #699DD1;}
        .btn-3d.green:hover  {background-color: #80C49D;}
        .btn-3d.purple:hover {background-color: #D19ECB;}
        .btn-3d.yellow:hover {background-color: #F0D264;}
        .btn-3d.cyan:hover   {background-color: #82D1E3;}

        .btn-3d:active {
            top: 9px;
        }

        /* 3D button colors */
        .btn-3d.red {
            background-color: #e74c3c;
            box-shadow: 0 0 0 1px #c63702 inset,
                0 0 0 2px rgba(255,255,255,0.15) inset,
                0 8px 0 0 #C24032,
                0 8px 0 1px rgba(0,0,0,0.4),
                        0 8px 8px 1px rgba(0,0,0,0.5);
        }
        .btn-3d.red:active {
            box-shadow: 0 0 0 1px #c63702 inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 0 0 1px rgba(0,0,0,0.4);
        }

        .btn-3d.blue {
            background-color: #6DA2D9;
            box-shadow: 0 0 0 1px #6698cb inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 8px 0 0 rgba(110, 164, 219, .7),
                        0 8px 0 1px rgba(0,0,0,.4),
                        0 8px 8px 1px rgba(0,0,0,0.5);
        }
        .btn-3d.blue:active {
            box-shadow: 0 0 0 1px #6191C2 inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 0 0 1px rgba(0,0,0,0.4);
        }

        .btn-3d.green {
            background-color: #82c8a0;
            box-shadow: 0 0 0 1px #82c8a0 inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 8px 0 0 rgba(126, 194, 155, .7),
                        0 8px 0 1px rgba(0,0,0,.4),
                        0 8px 8px 1px rgba(0,0,0,0.5);
        }
        .btn-3d.green:active {
            box-shadow: 0 0 0 1px #82c8a0 inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 0 0 1px rgba(0,0,0,0.4);
        }

        .btn-3d.purple {
            background-color: #cb99c5;
            box-shadow: 0 0 0 1px #cb99c5 inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 8px 0 0 rgba(189, 142, 183, .7),
                        0 8px 0 1px rgba(0,0,0,.4),
                        0 8px 8px 1px rgba(0,0,0,0.5);
        }
        .btn-3d.purple:active {
            box-shadow: 0 0 0 1px #cb99c5 inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 0 0 1px rgba(0,0,0,0.4);
        }

        .btn-3d.cyan {
            background-color: #7fccde;
            box-shadow: 0 0 0 1px #7fccde inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 8px 0 0 rgba(102, 164, 178, .6),
                        0 8px 0 1px rgba(0,0,0,.4),
                        0 8px 8px 1px rgba(0,0,0,0.5);
        }
        .btn-3d.cyan:active {
            box-shadow: 0 0 0 1px #7fccde inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 0 0 1px rgba(0,0,0,0.4);
        }

        .btn-3d.yellow {
            background-color: #F0D264;
            box-shadow: 0 0 0 1px #F0D264 inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 8px 0 0 rgba(196, 172, 83, .7),
                        0 8px 0 1px rgba(0,0,0,.4),
                        0 8px 8px 1px rgba(0,0,0,0.5);
        }
        .btn-3d.yellow:active {
            box-shadow: 0 0 0 1px #F0D264 inset,
                        0 0 0 2px rgba(255,255,255,0.15) inset,
                        0 0 0 1px rgba(0,0,0,0.4);
        }

        /* Gradient buttons */
        .btn-gradient {
            text-decoration: none;
            color: white;
            padding: 10px 30px;
            display: inline-block;
            position: relative;
            border: 1px solid rgba(0,0,0,0.21);
            border-bottom: 4px solid rgba(0,0,0,0.21);
            border-radius: 4px;
            text-shadow: 0 1px 0 rgba(0,0,0,0.15);
        }
        /* Gradient - ugly css is ugly */
        .btn-gradient.cyan {
            background: rgba(27,188,194,1);
            background: -webkit-gradient(linear, 0 0, 0 100%, from(rgba(27,188,194,1)), to(rgba(24,163,168,1)));
            background: -webkit-linear-gradient(rgba(27,188,194,1) 0%, rgba(24,163,168,1) 100%);
            background: -moz-linear-gradient(rgba(27,188,194,1) 0%, rgba(24,163,168,1) 100%);
            background: -o-linear-gradient(rgba(27,188,194,1) 0%, rgba(24,163,168,1) 100%);
            background: linear-gradient(rgba(27,188,194,1) 0%, rgba(24,163,168,1) 100%);
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#1bbcc2', endColorstr='#18a3a8', GradientType=0);
        }

        .btn-gradient.red{ 
            background: rgba(250,90,90,1);
            background: -webkit-gradient(linear, 0 0, 0 100%, from(rgba(250,90,90,1)), to(rgba(232,81,81,1)));
            background: -webkit-linear-gradient(rgba(250,90,90,1) 0%, rgba(232,81,81,1) 100%);
            background: -moz-linear-gradient(rgba(250,90,90,1) 0%, rgba(232,81,81,1) 100%);
            background: -o-linear-gradient(rgba(250,90,90,1) 0%, rgba(232,81,81,1) 100%);
            background: linear-gradient(rgba(250,90,90,1) 0%, rgba(232,81,81,1) 100%);
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#fa5a5a', endColorstr='#e85151', GradientType=0 );
        }
        .btn-gradient.orange {
            background: rgba(255,105,30,1);
            background: -webkit-gradient(linear, 0 0, 0 100%, from(rgba(255,105,30,1)), to(rgba(230,95,28,1)));
            background: -webkit-linear-gradient(rgba(255,105,30,1) 0%, rgba(230,95,28,1) 100%);
            background: -moz-linear-gradient(rgba(255,105,30,1) 0%, rgba(230,95,28,1) 100%);
            background: -o-linear-gradient(rgba(255,105,30,1) 0%, rgba(230,95,28,1) 100%);
            background: linear-gradient(rgba(255,105,30,1) 0%, rgba(230,95,28,1) 100%);
        }
        .btn-gradient.blue {
            background: rgba(102,152,203,1);
            background: -moz-linear-gradient(top, rgba(102,152,203,1) 0%, rgba(92,138,184,1) 100%);
            background: -webkit-gradient(left top, left bottom, color-stop(0%, rgba(102,152,203,1)), color-stop(100%, rgba(92,138,184,1)));
            background: -webkit-linear-gradient(top, rgba(102,152,203,1) 0%, rgba(92,138,184,1) 100%);
            background: -o-linear-gradient(top, rgba(102,152,203,1) 0%, rgba(92,138,184,1) 100%);
            background: -ms-linear-gradient(top, rgba(102,152,203,1) 0%, rgba(92,138,184,1) 100%);
            background: linear-gradient(to bottom, rgba(102,152,203,1) 0%, rgba(92,138,184,1) 100%);
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#6698cb', endColorstr='#5c8ab8', GradientType=0 );
        }
        .btn-gradient.purple { 
            background: rgba(203,153,197,1);
            background: -moz-linear-gradient(top, rgba(203,153,197,1) 0%, rgba(181,134,176,1) 100%);
            background: -webkit-gradient(left top, left bottom, color-stop(0%, rgba(203,153,197,1)), color-stop(100%, rgba(181,134,176,1)));
            background: -webkit-linear-gradient(top, rgba(203,153,197,1) 0%, rgba(181,134,176,1) 100%);
            background: -o-linear-gradient(top, rgba(203,153,197,1) 0%, rgba(181,134,176,1) 100%);
            background: -ms-linear-gradient(top, rgba(203,153,197,1) 0%, rgba(181,134,176,1) 100%);
            background: linear-gradient(to bottom, rgba(203,153,197,1) 0%, rgba(181,134,176,1) 100%);
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#cb99c5', endColorstr='#b586b0', GradientType=0 );
        }
        .btn-gradient.yellow {
            background: rgba(240,210,100,1);
            background: -webkit-gradient(linear, 0 0, 0 100%, from(rgba(240,210,100,1)), to(rgba(229,201,96,1)));
            background: -webkit-linear-gradient(rgba(240,210,100,1) 0%, rgba(229,201,96,1) 100%);
            background: -moz-linear-gradient(rgba(240,210,100,1) 0%, rgba(229,201,96,1) 100%);
            background: -o-linear-gradient(rgba(240,210,100,1) 0%, rgba(229,201,96,1) 100%);
            background: linear-gradient(rgba(240,210,100,1) 0%, rgba(229,201,96,1) 100%);
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#f0d264', endColorstr='#e5c960', GradientType=0 );
        }
        .btn-gradient.green {
            background: rgba(130,200,160,1);
            background: -moz-linear-gradient(top, rgba(130,200,160,1) 0%, rgba(130,199,158,1) 100%);
            background: -webkit-gradient(left top, left bottom, color-stop(0%, rgba(130,200,160,1)), color-stop(100%, rgba(130,199,158,1)));
            background: -webkit-linear-gradient(top, rgba(130,200,160,1) 0%, rgba(130,199,158,1) 100%);
            background: -o-linear-gradient(top, rgba(130,200,160,1) 0%, rgba(130,199,158,1) 100%);
            background: -ms-linear-gradient(top, rgba(130,200,160,1) 0%, rgba(130,199,158,1) 100%);
            background: linear-gradient(to bottom, rgba(130,200,160,1) 0%, rgba(124, 185, 149, 1) 100%);
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#82c8a0', endColorstr='#82c79e', GradientType=0 );
        }

        .btn-gradient.red:active 	  {background: #E35252;}
        .btn-gradient.orange:active {background: #E8601B;}
        .btn-gradient.cyan:active 	{background: #169499;}
        .btn-gradient.blue:active 	{background: #608FBF;}
        .btn-gradient.purple:active {background: #BD8EB7;}
        .btn-gradient.yellow:active {background: #DBC05B;}
        .btn-gradient.green:active  {background: #72B08E;}

    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-fire"></i> Cargo-dephell</h1>
        </div>
    </header>
    <div class="container">
        <p id="jumbotron">
            
            This page was generated with <a href="https://github.com/mimoo/cargo-dephell">cargo dephell</a>. It lists the dependencies used by <strong>{{name}}</strong>.<br>
            The crates used in the analysis are: <span id="root_crates"></span>.<br>
            For more information about the methodology check the <a href="https://github.com/mimoo/cargo-dephell">README</a>.
        </p>
        <nav>
            <div id="buttons">
                <a href="#" id="btn_target_feature" class="btn-gradient cyan mini"><i class="fas fa-tools"></i> not showing unused dependencies</a>
                <a href="#" id="btn_total_loc" class="btn-gradient orange mini"><i class="fas fa-align-center"></i> showing lines of code for transitive dependencies</a>
                <a href="#" id="btn_transitive_deps" class="btn-gradient green mini"><i class="fas fa-plus"></i> not showing transitive dependencies</a>
                <a href="#" id="btn_internal_deps" class="btn-gradient purple mini"><i class="fab fa-font-awesome-flag"></i> not showing internal dependencies</a>
            </div>
            <!-- TODO: change URL with `crumble` when clicking + keep what's sorted in memory -->
            <div id="crumble"></div>
        </nav>
        <div id="info">
            <div id="description"></div>
            <div id="root_importers"></div>
            <div id="exclusive_deps_introduced"></div>
        </div>
        <table>
            <thead>
                <tr>
                    <th width="150px">
                        <a href="#name" data-tippy-content="the name of the dependency">
                            name
                        </a><br>
                    </th>
                    <th>
                        <a href="#transitive_dependencies" data-tippy-content="the number of dependencies that this package end up adding (if all features are set) not including this package">
                            transitive deps
                        </a><br>
                    </th>
                    <th>
                        <a href="#versions" data-tippy-content="the number of different versions of this dependency that are imported in the workspace">
                            versions imported
                        </a><br>
                    </th>
                    <th>
                        <a href="#root_importers" data-tippy-content="the number of workspace crates that have this dependency as transitive dependency">
                            root importers
                        </a><br>
                    </th>
                    <th>
                        <a href="#exclusive_deps_introduced" data-tippy-content="the number of dependencies that are introduced only by having this dependency">
                            new deps
                        </a><br>
                    </th>
                    <th class="total">
                        <a href="#total_loc" data-tippy-content="total lines of code for anything (not just rust) that might end up being imported by having this dependency (this includes transitive dependencies)">
                            total loc
                        </a><br>
                    </th>
                    <th class="total">
                        <a href="#total_rust_loc" data-tippy-content="total lines of rust code for this dependency and its transitive dependencies">
                            total rust loc
                        </a><br>
                    </th>
                    <th class="total">
                        <a href="#total_unsafe_loc" data-tippy-content="total lines of unsafe rust code for this dependency and its transitive dependencies">
                            total unsafe loc
                        </a><br>
                    </th>
                    <th class="not_total hide">
                        <a href="#loc" data-tippy-content="lines of code for anything (not just rust) for this dependency">
                            loc
                        </a><br>
                    </th>
                    <th class="not_total hide">
                        <a href="#rust_loc" data-tippy-content="lines of rust code for this dependency">
                            rust loc
                        </a><br>
                    </th>
                    <th class="not_total hide">
                        <a href="#unsafe_loc" data-tippy-content="lines of unsafe rust code for this dependency">
                            unsafe loc
                        </a><br>
                    </th>
                    <th>
                        <a href="#stargazers_count" data-tippy-content="number of github stars (only if the dependency has a github repository)">
                            github stars
                        </a><br>
                    </th>
                    <th>
                        <a href="#active_contributors" data-tippy-content="number of contributors on the github repo in the last 6 months">
                            active contributors
                        </a><br>
                    </th>
                    <th>
                        <a href="#crates_io_dependent" data-tippy-content="number of published crates.io crates that depends on this crate">
                            crates.io dependents
                        </a><br>
                    </th>
                    <th width="100px">
                        <a href="#crates_io_last_updated" data-tippy-content="last time a version was published on crates.io">
                            last updated
                        </a><br>
                    </th>
                </tr>
            </thead>
            <tbody>
                
            </tbody>
        </table>
        
    </div>

    <!-- tooltip with tippy -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <!-- custom -->
    <script>
        // TODO: https://github.com/magjac/d3-graphviz for dot

        //
        // metric functions
        //

        // TODO: use this somewhere
        weights = {
            'transitive_dependencies': 5,
            'root_importers': 1,
            'exclusive_deps_introduced': 5,
            'loc': 1,
            'rust_loc': 5,
            'unsafe_loc': 1,
            'stargazers_count': 1,
            'active_contributors': 1,
            'crates_io_dependent': 1,
            'crates_io_last_updated': 1,
        };

        function calculate_risk(package_id) {
            let package_risk = analysis_result[package_id];
            let risk_score = 0;
            for (metric of ['transitive_dependencies', 'root_importers', 'exclusive_deps_introduced', 'loc', 'rust_loc', 'unsafe_loc', 'stargazers_count', 'active_contributors', 'crates_io_dependent', 'crates_io_last_updated']) {
                let actual_number = package_risk[metric];
                if (Array.isArray(actual_number)) {
                    actual_number = actual_number.length;
                }
                risk_score += weights[metric] * actual_number;
            }
            return risk_score;
        }

        function calculate_total_loc(package_id) {
            let backtrack = [];
            let package_ids = [package_id];
            let sorted = [];
            while (true) {
                // get next element
                let package_id = package_ids.pop();
                // get its children
                let next_deps = analysis_result[package_id].direct_dependencies;
                // easy: it doesn't have children
                if (next_deps.length == 0) {
                    analysis_result[package_id]["total_loc"] = analysis_result[package_id]["loc"];
                    analysis_result[package_id]["total_rust_loc"] = analysis_result[package_id]["rust_loc"];
                    analysis_result[package_id]["total_unsafe_loc"] = analysis_result[package_id]["unsafe_loc"];
                } else {
                    // place back in queue
                    package_ids.push(package_id); 
                    // attempt to compute the total opportunistically
                    let can_update = true;
                    let total_loc = 0;
                    let total_rust_loc = 0;
                    let total_unsafe_loc = 0;
                    for (dependency of analysis_result[package_id].direct_dependencies) {
                        // if one of the child is not a leaf, 
                        // add it to the queue and stop the opportunistic count
                        if (!analysis_result[dependency].hasOwnProperty("total_rust_loc")) {
                            package_ids.push(dependency);
                            can_update = false;
                        } else if (can_update) {
                            // if we are still dealing with leaves, add up
                            total_loc += analysis_result[dependency]["total_loc"];
                            total_rust_loc += analysis_result[dependency]["total_rust_loc"];
                            total_unsafe_loc += analysis_result[dependency]["total_unsafe_loc"];
                        }
                    }
                    // update if all the children were leaves
                    if (can_update) {
                        analysis_result[package_id]["total_loc"] = total_loc;
                        analysis_result[package_id]["total_rust_loc"] = total_rust_loc;
                        analysis_result[package_id]["total_unsafe_loc"] = total_unsafe_loc;
                        // we can safely remove from queue now
                        package_ids.pop();
                    }
                }
                // are we done?
                if (package_ids.length == 0) {
                    return;
                }
            }
        }

        //
        // function to modify the table
        //

        // refresh the table to display `current_packages`
        function refresh_displayed_packages() {
            // re-calculate current packages based on config
            let current_packages = [];
            if (configuration.crumbles.length == 0) { // showing main deps
                if (configuration.show_transitive) { 
                    Object.keys(analysis_result).forEach( (pkg_id) => {
                        current_packages.push(pkg_id)
                    });
                } else {
                    current_packages = main_dependencies;
                }
            } else { // showing a specific package's dependencies
                let pkg_id = configuration.crumbles[configuration.crumbles.length - 1];
                if (configuration.show_transitive) {
                    current_packages = analysis_result[pkg_id]["transitive_dependencies"];
                } else { 
                    current_packages = analysis_result[pkg_id]["direct_dependencies"];
                }
            }
            // sort table
            if (configuration.sorted_asc) {
                current_packages.sort((a, b) => {
                    a = analysis_result[a][configuration.sorted_by];
                    b = analysis_result[b][configuration.sorted_by];
                    if (Array.isArray(a)) {
                        a = a.length;
                        b = b.length;
                    }
                    return (a > b) ? 1 : -1;
                });
            } else {
                current_packages.sort((a, b) => {
                    a = analysis_result[a][configuration.sorted_by];
                    b = analysis_result[b][configuration.sorted_by];
                    if (Array.isArray(a)) {
                        a = a.length;
                        b = b.length;
                    }
                    return (a < b) ? 1 : -1;
                });
            }
            // clean table
            document.querySelector("tbody").innerHTML = "";
            // display
            for(package_id of current_packages) {
                display_package(package_id);
            }
        }

        // display a package in the table dynamically based on current configuration
        function display_package(package_id) {
            // fetch analysis result for that package
            let package = analysis_result[package_id];

            // don't display the package if not used + configuration wants that
            if (!package.used && !configuration.show_not_used) {
                return;
            }
            // don't display the package if it's internal + configuration wants that
            if (package.internal && !configuration.show_internal) {
                return;
            }

            let html = "<tr>";

            if (package.internal) {
                html += '<td><i class="fab fa-font-awesome-flag"></i> <a href="#'+package_id+'" class="dep_name">' + package["name"] + '</a></td>';
            } else {
                html += '<td><a href="#'+package_id+'" class="dep_name">' + package["name"] + '</a></td>';
            }
            html += "<td>" + package["transitive_dependencies"].length + "</td>";
            html += "<td>" + package["versions"].length + "</td>";
            html += "<td>" + package["root_importers"].length + "</td>";
            html += "<td>" + package["exclusive_deps_introduced"].length + "</td>";

            if (configuration.show_total_loc) {
                html += '<td class="total">' + package["total_loc"].toLocaleString() + "</td>";
                html += '<td class="total">' + package["total_rust_loc"].toLocaleString() + "</td>";
                html += '<td class="total">' + package["total_unsafe_loc"].toLocaleString() + "</td>";
            } else {
                html += '<td class="not_total">' + package["loc"].toLocaleString() + "</td>";
                html += '<td class="not_total">' + package["rust_loc"].toLocaleString() + "</td>";
                html += '<td class="not_total">' + package["unsafe_loc"].toLocaleString() + "</td>";
            }

            if (package["stargazers_count"]) {
                html += '<td><a href="'+package["repo"]+'">' + package["stargazers_count"].toLocaleString() + "</a></td>";
            } else {
                html += "<td></td>";
            }

            if (package["active_contributors"]) {
                html += '<td><a href="'+package["repo"]+'">' + package["active_contributors"] + "</a></td>";
            } else {
                html += "<td></td>";
            }

            if (package["crates_io_dependent"]) {
                html += '<td>' + package["crates_io_dependent"].toLocaleString() + '</td>';
            } else {
                html += "<td></td>";
            }

            if (package["crates_io_last_updated"]) {
                html += '<td><a href="https://crates.io/crates/'+ package["name"] +'">' + package["crates_io_last_updated"] + '</a></td>';
            } else {
                html += "<td></td>";
            }

            html += "</tr>"
            document.querySelector("tbody").innerHTML += html;
        }

        //
        // buttons
        // -------
        //

        function toggle_wording(target) {
            if (target.innerHTML.includes("not showing")) {
                target.innerHTML = target.innerHTML.replace("not showing", "showing");
            } else {
                target.innerHTML = target.innerHTML.replace("showing", "not showing");
            }
        }

        // show/hide dependencies that are not part of our (target, features)
        document.querySelector("#btn_target_feature").addEventListener("click", (event) => {
            // toggle wording of button
            toggle_wording(event.target);
            // toggle config
            configuration.show_not_used = !configuration.show_not_used;
            // refresh display with new config
            refresh_displayed_packages();
            //
            event.preventDefault();
        });

        // toggle "total" LOC 
        document.querySelector("#btn_total_loc").addEventListener("click", (event) => {
            // toggle wording of button
            toggle_wording(event.target);
            // toggle total columns
            document.querySelectorAll(".total, .not_total").forEach(
                (elem) => elem.classList.toggle("hide")
            );
            // toggle config
            configuration.show_total_loc = !configuration.show_total_loc;
            // refresh display with new config
            refresh_displayed_packages();
            //
            event.preventDefault();
        });

        // toggle direct/transitive deps
        document.querySelector("#btn_transitive_deps").addEventListener("click", (event) => {
            // toggle wording of button
            toggle_wording(event.target);
            // toggle config
            configuration.show_transitive = !configuration.show_transitive;
            // refresh display with new config
            refresh_displayed_packages();
            //
            event.preventDefault();
        });

        // toggle internal deps
        document.querySelector("#btn_internal_deps").addEventListener("click", (event) => {
            // toggle wording of button
            toggle_wording(event.target);
            // toggle config
            configuration.show_internal = !configuration.show_internal;
            // refresh display with new config
            refresh_displayed_packages();
            //
            event.preventDefault();
        });

        //
        // crumble functions
        // -------------
        //

        let crumble_home = '<a href="#home" class="dep_crumble"><i class="fas fa-home"></i> {{name}}</a>'; 

        function refresh_crumble() {    
            let crumble = crumble_home;
            for (const [idx, dep_id] of configuration.crumbles.entries()) {
                let dep_name = analysis_result[dep_id]["name"];
                crumble += ' <i class="fas fa-caret-right"></i> <a href="#'+idx+'" class="dep_crumble">' + dep_name + '</a>';
            }
            document.querySelector("#crumble").innerHTML = crumble;
        }

        document.querySelector("#crumble").addEventListener("click", (event) => {
            if (event.target && event.target.className != "dep_crumble") {
                return;
            }
            // which element in the array
            let idx = event.target.getAttribute("href").slice(1);
            if (idx == "home") { // we clicked on home
                // reset crumbles
                configuration.crumbles = [];
                // reset dependency info text
                reset_dependency_info_text();
            } else {
                idx =  parseInt(idx);
                let package_id = configuration.crumbles[idx];
                configuration.crumbles = configuration.crumbles.slice(0, idx + 1);
            }
            // refresh displayed packages
            refresh_displayed_packages();
            // refresh crumble
            refresh_crumble();
            //
            event.preventDefault();
        });

        //
        // init
        // ----

        // setup a config 
        // TODO: persist this in real time via URL
        let configuration = {
            show_not_used: false,
            show_total_loc: true,
            show_transitive: false,
            show_internal: false,
            sorted_by: "name",
            sorted_asc: true,
            crumbles: []
        };

        // obtain result and parse JSON
        let {root_crates, main_dependencies, analysis_result} = JSON.parse(atob("{{ json_result }}"));

        // calculate total LOCs:
        for (dependency of main_dependencies) {
            calculate_total_loc(dependency);
        }

        // display jumbotron
        let root_crates_with_comma = root_crates.reduce( (acc, pkg_name) => acc + ", " + pkg_name);
        document.querySelector("#root_crates").innerHTML = root_crates_with_comma;

        // display crumble
        refresh_crumble();

        // display main dependencies
        refresh_displayed_packages();

        //
        // clicking on dependencies
        // ------------------------

        // TODO: remove this once we move from packageid to name
        function package_id_to_name(package_id) {
            return package_id.split(" ")[0];
        }

        function update_info(package_info) {
            if (package_info["description"]) {
                document.querySelector("#description").innerHTML = "<strong>description:</strong> " + package_info["description"];
            }
            if (package_info["root_importers"].length > 0) {
                let root_importers = "";
                package_info["root_importers"].forEach( (pkg_id) => {
                    root_importers += ", " + package_id_to_name(pkg_id);
                });
                document.querySelector("#root_importers").innerHTML = "<strong>importers:</strong> " + root_importers.slice(2);
                
            }
            if (package_info["exclusive_deps_introduced"].length > 0) {
                let exclusive_deps_introduced = "";
                package_info["exclusive_deps_introduced"].forEach( (pkg_id) => {
                    return exclusive_deps_introduced += ", " + package_id_to_name(pkg_id);
                });
                document.querySelector("#exclusive_deps_introduced").innerHTML = "<strong>exclusive dependencies introduced</strong>: " + exclusive_deps_introduced.slice(2);
            }
        }

        function reset_dependency_info_text() {
            document.querySelector("#description").innerHTML = "";
            document.querySelector("#root_importers").innerHTML = "";
            document.querySelector("#exclusive_deps_introduced").innerHTML = "";
        }

        // clicking on a dependency gives us a view of a specific dependency
        document.querySelector("tbody").addEventListener("click", (event) => {
            if (event.target && event.target.className != "dep_name") {
                return;
            }
            // get info
            let package_name = event.target.innerHTML; // necessary for main deps
            let package_id = event.target.getAttribute("href").slice(1);
            // add to crumbles
            configuration.crumbles.push(dep_id);
            refresh_crumble();
            // display info about the dependency
            let package_info = analysis_result[package_id];
            update_info(package_info)
            // display new packages
            refresh_displayed_packages();
            //
            event.preventDefault();
        });

        //
        // sorting
        // ------

        const sort_buttons = document.querySelectorAll("th a");
        for (const sort_button of sort_buttons) {
            sort_button.addEventListener("click", (event) => sort_click(event));
        }

        function reset_sort_icons() {
            const sort_buttons = document.querySelectorAll("th svg").forEach(e => e.parentNode.removeChild(e));
        }
        
        function sort_click(event) {
            // get info
            let to_sort = event.target.getAttribute("href").slice(1); // get rid of "#..."
            // set new configuration
            if (configuration.sorted_by == to_sort) {
                // if we already sorted with this column, invert it
                configuration.sorted_asc = !configuration.sorted_asc;
            } else {
                configuration.sorted_by = to_sort;
                configuration.sorted_asc = false; // by default sort by DESC order
            }
            // reset sort icons
            reset_sort_icons();
            // sort and update sort icon
            if (configuration.sorted_asc) {
                event.target.innerHTML += '<i class="fas fa-sort-up"></i>';   
            } else {
                event.target.innerHTML += '<i class="fas fa-sort-down"></i>';
            }
            // refresh table with new configuration
            refresh_displayed_packages();
            //
            event.preventDefault();
        }

        //
        // tooltip for help
        // ----------------

        tippy('[data-tippy-content]', {
            placement: 'bottom',
            animation: 'shift-away'
        });

    </script>
</body>

</html>